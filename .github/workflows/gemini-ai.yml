name: Gemini AI Assistant

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch:
    inputs:
      prompt:
        description: 'Custom prompt for Gemini'
        required: true
        default: 'Analyze the codebase and suggest improvements'

jobs:
  # Auto-respond to issues with Gemini
  respond-to-issues:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues'
    permissions:
      issues: write
      contents: read
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Run Gemini CLI - Issue Analysis
      uses: google-github-actions/run-gemini-cli@v0.1.20
      with:
        gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
        command: |
          echo "Analyzing issue: ${{ github.event.issue.title }}" && \
          echo "Body: ${{ github.event.issue.body }}" && \
          gemini analyze --context "EKA-AI Platform - Workshop Management System"
          
    - name: Comment with Gemini Response
      uses: actions/github-script@v7
      with:
        script: |
          const response = process.env.GEMINI_RESPONSE || 'Analysis complete';
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ðŸ¤– Gemini AI Response\n\n${response}\n\n---\n*This is an automated response. Please assign a human if further assistance is needed.*`
          });

  # Generate code suggestions on PR
  code-suggestions:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
      contents: read
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Get changed files
      id: changed-files
      run: |
        echo "files=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | grep -E '\.(ts|tsx|js|jsx)$' | tr '\n' ' ')" >> $GITHUB_OUTPUT
        
    - name: Run Gemini CLI - Code Suggestions
      uses: google-github-actions/run-gemini-cli@v0.1.20
      with:
        gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
        command: |
          gemini suggest \
            --files ${{ steps.changed-files.outputs.files }} \
            --context "React TypeScript application with Tailwind CSS" \
            --output-format markdown
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Post suggestions as PR review
      uses: actions/github-script@v7
      if: always()
      with:
        script: |
          const fs = require('fs');
          const suggestions = fs.existsSync('gemini-suggestions.md')
            ? fs.readFileSync('gemini-suggestions.md', 'utf8')
            : 'No suggestions at this time.';
            
          github.rest.pulls.createReview({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number,
            body: `## ðŸ’¡ Gemini AI Code Suggestions\n\n${suggestions}`,
            event: 'COMMENT'
          });

  # Custom Gemini prompt execution
  custom-prompt:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Run Gemini with Custom Prompt
      uses: google-github-actions/run-gemini-cli@v0.1.20
      with:
        gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
        command: |
          gemini prompt "${{ github.event.inputs.prompt }}" \
            --repo-context \
            --output-format markdown
            
    - name: Upload results
      uses: actions/upload-artifact@v4
      with:
        name: gemini-response
        path: gemini-response.md
        retention-days: 30
